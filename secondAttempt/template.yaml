apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: requirefalconnamespace
spec:
  crd:
    spec:
      names:
        kind: RequireFalconNamespace
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package requirefalconnamespace

         # Get all namespace names and check for falcon-system
        namespace_names = [name | 
            # Access the namespaces from data.inventory.cluster.v1.Namespace
            namespace = data.inventory.cluster.v1.Namespace
            name = namespace[_].metadata.name
            name == "falcon-system"
        ]

        violation[{"msg": msg}] {
          count(namespace_names) == 0
          msg := sprintf("CrowdStrike Falcon agent does not exist: %v", [namespace_names])
        }
